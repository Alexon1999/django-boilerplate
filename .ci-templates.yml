.on-release:
  rules:
    - if: "$CI_COMMIT_BRANCH =~ /^release\\/.*$/"
      when: always

.build-kaniko:
  allow_failure: false
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - echo "{\"auths\":{\"$REGISTRY_URL \":{\"username\":\"$REGISTRY_USER\",\"password\":\"$REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor --context . --dockerfile $DOCKERFILE_PATH --destination $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG $DOCKER_BUILD_ARGS
  variables:
    DOCKERFILE_PATH: Dockerfile
    DOCKER_BUILD_ARGS: ""

.environment-django-ci:
  image: python:3.9.17-slim-bullseye
  services:
    - postgres:latest
  variables:
    POSTGRES_DB: boilerplate
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  before_script:
    - apt-get update && apt-get install -y build-essential netcat
    - pip install --upgrade pip --cache-dir="$PIP_CACHE_DIR"
    - pip install --cache-dir="$PIP_CACHE_DIR" -r requirements.txt
    - echo "$ENV_CI" > .env
    - chmod +x ./scripts/loadenv.sh
    - source ./scripts/loadenv.sh .env
